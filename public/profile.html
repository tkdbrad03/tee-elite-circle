<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/images/tee-elite-favicon.png">
  <title>My Profile — Tee Elite Invitational</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#163326">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tee Elite">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="pwa-nav.css">
  <style>
    :root{
      --green:#163326;--green2:#1E3A2B;--gold:#A87C28;--gold2:#C9A24A;
      --gold-lt:#EDD9A3;--white:#FFFFFF;--off:#F8F7F4;--ink:#163326;
      --body:#2C2C2C;--muted:#555555;--line:rgba(0,0,0,.12);
      --serif:"Cormorant Garamond",Georgia,serif;
      --sans:"Jost",ui-sans-serif,system-ui,sans-serif;
      --tmac-bronze:#A87C28;--tmac-gold:#C9A24A;--tmac-blush:#e8ccc8;
      --tmac-blush-light:#f7f0ef;--deep-forest:#163326;--charcoal:#2C2C2C;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:var(--sans);background:var(--white);color:var(--body);-webkit-font-smoothing:antialiased;}

    .page-container{max-width:800px;margin:0 auto;padding:40px 24px 120px}

    /* ── BACK LINK ── */
    .back-link{
      display:inline-flex;align-items:center;gap:8px;
      font-size:13px;color:var(--gold);text-decoration:none;
      margin-bottom:32px;font-weight:400;
      display:none;
    }
    .back-link:hover{text-decoration:underline}
    body.viewing-other .back-link{display:inline-flex}

    /* ── PHOTO SECTION ── */
    .photo-section{text-align:center;margin-bottom:40px}
    .profile-photo-wrap{position:relative;display:inline-block}
    .profile-photo{
      width:120px;height:120px;border-radius:50%;
      background:var(--tmac-blush-light);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;margin:0 auto;
    }
    .profile-photo img{width:100%;height:100%;object-fit:cover}
    .profile-photo .initials{
      font-family:var(--serif);font-size:48px;
      color:var(--gold);opacity:.7;
    }
    .photo-upload-btn{
      position:absolute;bottom:4px;right:4px;
      background:var(--green);color:var(--tmac-blush);
      border:none;width:36px;height:36px;border-radius:50%;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,.2);transition:all .2s;
    }
    .photo-upload-btn:hover{transform:scale(1.08)}
    .photo-upload-btn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
    .profile-name-display{
      font-family:var(--serif);font-size:28px;font-weight:400;
      color:var(--ink);margin-top:16px;margin-bottom:4px;
    }
    .profile-email-display{font-size:13px;color:var(--muted);font-weight:300}

    /* ── CARD ── */
    .profile-card{
      background:var(--white);border:1px solid var(--line);
      border-radius:20px;padding:32px;margin-bottom:24px;
    }
    .card-title{
      font-family:var(--serif);font-size:22px;font-weight:400;
      color:var(--ink);margin-bottom:24px;padding-bottom:14px;
      border-bottom:1px solid var(--line);
    }

    /* ── FORM ── */
    .form-group{margin-bottom:22px}
    .form-label{
      display:block;font-size:11px;letter-spacing:.15em;
      text-transform:uppercase;color:var(--muted);margin-bottom:8px;font-weight:500;
    }
    .form-input,.form-textarea{
      width:100%;padding:14px 18px;
      font-family:var(--sans);font-size:14px;font-weight:300;
      color:var(--ink);
      border:1.5px solid rgba(22,51,38,.18);border-radius:999px;
      outline:none;transition:border-color .2s;background:var(--white);
    }
    .form-textarea{border-radius:16px;min-height:120px;resize:vertical}
    .form-input:focus,.form-textarea:focus{border-color:var(--gold2)}
    .form-input:disabled{background:var(--off);color:var(--muted);cursor:not-allowed}
    .form-help{font-size:12px;color:#aaa;margin-top:6px;font-weight:300}

    /* ── SCORECARD PREVIEW ── */
    .scorecard-preview{
      background:var(--off);border:1px solid var(--line);
      border-radius:16px;padding:20px 24px;margin-bottom:22px;
    }
    .scorecard-preview-label{
      font-size:10px;letter-spacing:.15em;text-transform:uppercase;
      color:var(--gold);margin-bottom:10px;
    }
    .scorecard-preview-text{font-size:15px;color:var(--ink);line-height:1.8;font-style:italic;font-weight:300}
    .scorecard-empty{font-size:13px;color:#bbb;font-style:normal}

    /* ── BUTTONS ── */
    .btn-gold{
      display:inline-block;padding:15px 40px;
      background:linear-gradient(135deg,#C8A84B 0%,#E8D48A 35%,#F0E09A 50%,#D4A84A 70%,#B8922E 100%);
      color:var(--green);border:none;border-radius:999px;
      font-family:var(--sans);font-size:12px;letter-spacing:.14em;
      text-transform:uppercase;font-weight:700;cursor:pointer;
      box-shadow:0 8px 24px rgba(168,124,40,.26);transition:all .2s;
    }
    .btn-gold:hover{transform:translateY(-1px);box-shadow:0 12px 30px rgba(168,124,40,.34)}
    .btn-gold:disabled{opacity:.4;cursor:not-allowed;transform:none}
    .save-message{
      display:inline-block;margin-left:14px;
      font-size:13px;color:#4caf50;
      opacity:0;transition:opacity .3s;vertical-align:middle;
    }
    .save-message.visible{opacity:1}

    /* ── VIEW-ONLY MODE ── */
    .edit-only{display:block}
    .view-only{display:none}
    body.viewing-other .edit-only{display:none}
    body.viewing-other .view-only{display:block}

    .view-field{margin-bottom:20px}
    .view-field-label{
      font-size:10px;letter-spacing:.15em;text-transform:uppercase;
      color:var(--gold);margin-bottom:6px;
    }
    .view-field-value{font-size:15px;color:var(--ink);line-height:1.7;font-weight:300}
    .view-field-empty{font-size:14px;color:#bbb;font-style:italic}

    @media(max-width:600px){
      .page-container{padding-bottom:120px}
      .btn-gold{width:100%;text-align:center}
    }
  </style>
</head>
<body class="member-body">

  <header class="member-header">
    <div class="header-inner">
      <a href="/home.html" class="header-logo">
        <img src="images/tmac-logo.png" alt="TMac Inspired">
      </a>
      <nav class="header-nav">
        <a href="/home.html" class="nav-link">Hub</a>
        <a href="/tee-room.html" class="nav-link">Tee Room</a>
        <a href="/members.html" class="nav-link">The Circle</a>
        <a href="/tee-elite-invitational.html" class="nav-link">The Invitational</a>
      </nav>
      <div class="header-user">
        <a href="/profile.html" class="user-avatar active" id="user-avatar">
          <span id="user-initials">TM</span>
        </a>
      </div>
      <button class="mobile-menu-btn" id="mobile-menu-btn">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <div class="mobile-nav" id="mobile-nav">
    <a href="/home.html" class="mobile-nav-link">Hub</a>
    <a href="/tee-room.html" class="mobile-nav-link">Tee Room</a>
    <a href="/members.html" class="mobile-nav-link">The Circle</a>
    <a href="/tee-elite-invitational.html" class="mobile-nav-link">The Invitational</a>
    <a href="/profile.html" class="mobile-nav-link active">My Profile</a>
  </div>

  <main class="page-container">

    <a href="/members.html" class="back-link">← Back to The Circle</a>

    <!-- PHOTO + NAME -->
    <div class="photo-section">
      <div class="profile-photo-wrap">
        <div class="profile-photo" id="profile-photo">
          <span class="initials" id="photo-initials">TM</span>
        </div>
        <button class="photo-upload-btn edit-only" id="photo-upload-btn" title="Change photo">
          <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <input type="file" id="photo-input" accept="image/*" style="display:none">
      </div>
      <div class="profile-name-display" id="profile-name-display">Loading…</div>
      <div class="profile-email-display edit-only" id="profile-email-display"></div>
      <!-- view-only name handled by profile-name-display -->
    </div>

    <!-- EDIT MODE: PROFILE FORM -->
    <div class="edit-only">
      <form id="profile-form">

        <div class="profile-card">
          <div class="card-title">Basic Info</div>

          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="name" name="name" placeholder="Your name">
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="email" name="email" disabled>
            <p class="form-help">Contact support to change your email.</p>
          </div>
        </div>

        <div class="profile-card">
          <div class="card-title">Golf Profile</div>

          <div class="form-group">
            <label class="form-label">Handicap Index</label>
            <input type="text" class="form-input" id="handicap" name="handicap" placeholder="e.g. 14.2">
            <p class="form-help">Your official GHIN handicap index. Visible to other members.</p>
          </div>

          <div class="form-group">
            <label class="form-label">Favorite Course</label>
            <input type="text" class="form-input" id="favorite_course" name="favorite_course" placeholder="e.g. Summerfield Crossing">
            <p class="form-help">Visible to other members on The Circle page.</p>
          </div>
        </div>

        <div class="profile-card">
          <div class="card-title">The Finished Scorecard</div>

          <div class="scorecard-preview">
            <div class="scorecard-preview-label">Your Vision</div>
            <div class="scorecard-preview-text" id="scorecard-preview">
              <span class="scorecard-empty">You haven't set your vision yet. What does your win look like?</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">What Does Your Win Look Like?</label>
            <textarea class="form-textarea" id="finished_scorecard" name="finished_scorecard" placeholder="Play from the end. You've already won. Describe it in vivid detail..."></textarea>
            <p class="form-help">Write as if it's already happened. This is the vision you're playing toward.</p>
          </div>
        </div>

        <button type="submit" class="btn-gold" id="save-btn">Save Changes</button>
        <span class="save-message" id="save-message">Saved</span>

      </form>
    </div>

    <!-- VIEW-ONLY MODE (viewing another player) -->
    <div class="view-only">
      <div class="profile-card">
        <div class="card-title">Golf Profile</div>
        <div class="view-field">
          <div class="view-field-label">Handicap</div>
          <div class="view-field-value" id="view-handicap"><span class="view-field-empty">Not set yet.</span></div>
        </div>
        <div class="view-field">
          <div class="view-field-label">Favorite Course</div>
          <div class="view-field-value" id="view-favorite-course"><span class="view-field-empty">Not set yet.</span></div>
        </div>
      </div>

      <div class="profile-card">
        <div class="card-title">The Finished Scorecard</div>
        <div class="scorecard-preview">
          <div class="scorecard-preview-label">Their Vision</div>
          <div class="scorecard-preview-text" id="view-scorecard">
            <span class="scorecard-empty">This player hasn't set their vision yet.</span>
          </div>
        </div>
      </div>
    </div>

  </main>

  <nav class="pwa-bottom-nav">
    <div class="pwa-bottom-nav-inner">
      <a href="/home.html" class="pwa-nav-item">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Hub
      </a>
      <a href="/tee-room.html" class="pwa-nav-item">
        <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>Tee Room
      </a>
      <a href="/members.html" class="pwa-nav-item">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Circle
      </a>
      <a href="/profile.html" class="pwa-nav-item active">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Profile
      </a>
    </div>
  </nav>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const viewingPlayerId = urlParams.get('id');

    document.getElementById('mobile-menu-btn').addEventListener('click', function() {
      this.classList.toggle('active');
      document.getElementById('mobile-nav').classList.toggle('open');
    });

    async function loadPlayer() {
      try {
        const meRes = await fetch('/api/members/me');
        if (!meRes.ok) { window.location.href = '/member-login.html'; return; }
        const me = await meRes.json();

        const initials = getInitials(me.name);
        document.getElementById('user-initials').textContent = initials;

        if (viewingPlayerId && viewingPlayerId != me.id) {
          // Viewing someone else's profile
          document.body.classList.add('viewing-other');
          document.title = 'Player Profile — Tee Elite';
          await loadOtherPlayer(viewingPlayerId);
        } else {
          // Own profile
          populateForm(me);
        }
      } catch (err) {
        console.error('Error loading profile:', err);
        window.location.href = '/member-login.html';
      }
    }

    async function loadOtherPlayer(id) {
      try {
        const res = await fetch('/api/members/get?id=' + id);
        if (!res.ok) { window.location.href = '/members.html'; return; }
        const player = await res.json();
        if (!player) { window.location.href = '/members.html'; return; }
        populateViewOnly(player);
      } catch (err) {
        window.location.href = '/members.html';
      }
    }

    function populateForm(member) {
      document.getElementById('profile-name-display').textContent = member.name || '';
      document.getElementById('profile-email-display').textContent = member.email || '';
      document.getElementById('photo-initials').textContent = getInitials(member.name);
      document.getElementById('name').value = member.name || '';
      document.getElementById('email').value = member.email || '';
      document.getElementById('handicap').value = member.handicap || '';
      document.getElementById('favorite_course').value = member.favorite_course || '';
      document.getElementById('finished_scorecard').value = member.finished_scorecard || '';

      if (member.photo_url) {
        document.getElementById('profile-photo').innerHTML = `<img src="${member.photo_url}" alt="${member.name}">`;
      }
      if (member.finished_scorecard) {
        document.getElementById('scorecard-preview').innerHTML = member.finished_scorecard;
      }
    }

    function populateViewOnly(player) {
      document.getElementById('profile-name-display').textContent = player.name || 'Member';
      document.getElementById('photo-initials').textContent = getInitials(player.name);
      document.title = (player.name || 'Player') + ' — Tee Elite';

      if (player.photo_url) {
        document.getElementById('profile-photo').innerHTML = `<img src="${player.photo_url}" alt="${player.name}">`;
      }
      document.getElementById('view-handicap').innerHTML =
        player.handicap ? player.handicap : '<span class="view-field-empty">Not set yet.</span>';
      document.getElementById('view-favorite-course').innerHTML =
        player.favorite_course ? player.favorite_course : '<span class="view-field-empty">Not set yet.</span>';
      document.getElementById('view-scorecard').innerHTML =
        player.finished_scorecard ? player.finished_scorecard : '<span class="scorecard-empty">This player hasn\'t set their vision yet.</span>';
    }

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('save-btn');
      const msg = document.getElementById('save-message');
      btn.disabled = true;
      btn.textContent = 'Saving…';

      const formData = {
        name: document.getElementById('name').value,
        handicap: document.getElementById('handicap').value,
        favorite_course: document.getElementById('favorite_course').value,
        finished_scorecard: document.getElementById('finished_scorecard').value
      };

      try {
        const res = await fetch('/api/members/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (res.ok) {
          // Update displayed name
          document.getElementById('profile-name-display').textContent = formData.name;
          document.getElementById('user-initials').textContent = getInitials(formData.name);
          document.getElementById('photo-initials').textContent = getInitials(formData.name);
          // Update scorecard preview
          if (formData.finished_scorecard) {
            document.getElementById('scorecard-preview').innerHTML = formData.finished_scorecard;
          }
          msg.classList.add('visible');
          setTimeout(() => msg.classList.remove('visible'), 3000);
        } else {
          alert('Failed to save. Please try again.');
        }
      } catch (err) {
        alert('Error saving profile.');
      }

      btn.disabled = false;
      btn.textContent = 'Save Changes';
    });

    // Photo upload
    document.getElementById('photo-upload-btn').addEventListener('click', () => {
      document.getElementById('photo-input').click();
    });

    document.getElementById('photo-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('photo', file);
      try {
        const res = await fetch('/api/members/upload-photo', { method: 'POST', body: formData });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('profile-photo').innerHTML = `<img src="${data.photo_url}" alt="Profile">`;
        } else {
          alert('Upload failed. Please try again.');
        }
      } catch (err) {
        alert('Error uploading photo.');
      }
    });

    function getInitials(name) {
      if (!name) return 'TM';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    loadPlayer();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(r => console.log('SW registered:', r.scope))
          .catch(e => console.log('SW failed:', e));
      });
    }
  </script>

</body>
</html>
