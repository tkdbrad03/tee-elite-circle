<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/images/tee-elite-favicon.png">
  <title>Live ‚Äî The Tee Elite Circle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="pwa-nav.css">
  <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
  <style>
    :root {
      --tmac-blush: #e8ccc8;
      --tmac-bronze: #a67c52;
      --tmac-blush-light: #f7f0ef;
      --deep-forest: #1a2f23;
      --soft-cream: #FAF8F5;
      --charcoal: #2C2C2C;
    }

    .live-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--tmac-bronze); text-decoration: none; margin-bottom: 24px; }
    .live-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .live-badge { display: flex; align-items: center; gap: 8px; background: #c0392b; color: #fff; padding: 8px 16px; font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; animation: pulse 2s infinite; }
    .live-badge::before { content: ''; width: 8px; height: 8px; background: #fff; border-radius: 50%; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .live-topic { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--charcoal); }
    .live-wrapper { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
    .video-section { display: flex; flex-direction: column; }
    .video-container { position: relative; background: #000; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; }
    #remote-video { width: 100%; height: 100%; object-fit: contain; }
    .video-placeholder { text-align: center; color: rgba(255,255,255,0.5); }
    .video-placeholder svg { width: 64px; height: 64px; margin-bottom: 16px; }
    .local-preview { position: absolute; bottom: 16px; right: 16px; width: 150px; aspect-ratio: 16/9; background: #000; border: 2px solid var(--tmac-blush); border-radius: 4px; overflow: hidden; display: none; }
    .local-preview.visible { display: block; }
    .local-preview video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .connection-status { padding: 12px 16px; background: #f0f0f0; font-size: 13px; color: #666; display: flex; align-items: center; justify-content: space-between; }
    .status-left { display: flex; align-items: center; gap: 8px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #888; }
    .status-dot.connecting { background: #f39c12; animation: blink 1s infinite; }
    .status-dot.connected { background: #27ae60; }
    .status-dot.error { background: #c0392b; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .viewer-controls { display: flex; gap: 8px; }
    .control-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; font-family: 'Montserrat', sans-serif; font-size: 11px; border: none; cursor: pointer; transition: all 0.2s ease; border-radius: 4px; }
    .control-btn svg { width: 16px; height: 16px; }
    .control-btn.secondary { background: #f0f0f0; color: #666; }
    .control-btn.secondary:hover { background: #e0e0e0; }
    .control-btn.muted { background: #c0392b !important; color: #fff !important; }
    .chat-sidebar { background: #fff; border: 1px solid rgba(0,0,0,0.06); display: flex; flex-direction: column; height: 500px; }
    .chat-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .chat-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--charcoal); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }
    .chat-message { margin-bottom: 16px; }
    .chat-author { font-size: 12px; font-weight: 500; color: var(--tmac-bronze); margin-bottom: 4px; }
    .chat-text { font-size: 14px; color: var(--charcoal); line-height: 1.5; }
    .chat-input-area { padding: 12px 16px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 10px 14px; font-family: 'Montserrat', sans-serif; font-size: 13px; border: 1px solid rgba(0,0,0,0.1); outline: none; }
    .chat-send { padding: 10px 16px; background: var(--deep-forest); color: #fff; border: none; font-family: 'Montserrat', sans-serif; font-size: 12px; cursor: pointer; }

    /* Join Modal */
    .join-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .join-modal.hidden { display: none; }
    .join-modal-content { background: #fff; padding: 32px; max-width: 450px; width: 90%; text-align: center; border-radius: 8px; }
    .join-modal h2 { font-family: 'Cormorant Garamond', serif; font-size: 28px; margin-bottom: 8px; color: var(--charcoal); }
    .join-modal p { color: #666; margin-bottom: 24px; font-size: 14px; }
    .preview-video { width: 100%; aspect-ratio: 16/9; background: #000; margin-bottom: 24px; border-radius: 4px; overflow: hidden; }
    .preview-video video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .preview-video p { color: #666; padding: 60px 20px; }
    .join-options { display: flex; flex-direction: column; gap: 12px; }
    .join-btn { padding: 14px 24px; font-family: 'Montserrat', sans-serif; font-size: 13px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; border-radius: 4px; }
    .join-btn svg { width: 20px; height: 20px; }
    .join-btn.with-video { background: var(--deep-forest); color: #fff; }
    .join-btn.with-video:hover { background: var(--charcoal); }
    .join-btn.watch-only { background: #f0f0f0; color: var(--charcoal); }
    .join-btn.watch-only:hover { background: #e0e0e0; }

    /* Not Live */
    .not-live { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 24px; text-align: center; background: #fff; border: 1px solid rgba(0,0,0,0.06); }
    .not-live-icon { width: 80px; height: 80px; border-radius: 50%; background: var(--tmac-blush-light); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; }
    .not-live-icon svg { width: 40px; height: 40px; stroke: var(--tmac-bronze); }
    .not-live h2 { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--charcoal); margin-bottom: 12px; }
    .not-live p { font-size: 15px; color: #666; max-width: 400px; line-height: 1.7; }

    @media (max-width: 900px) { .live-wrapper { grid-template-columns: 1fr; } .chat-sidebar { height: 350px; } }
  </style>
</head>
<body class="member-body">
  
  <!-- JOIN MODAL -->
  <div class="join-modal hidden" id="join-modal">
    <div class="join-modal-content">
      <h2>Join the Live Session</h2>
      <p>How would you like to participate?</p>
      <div class="preview-video" id="preview-container">
        <video id="preview-video" autoplay muted playsinline></video>
      </div>
      <div class="join-options">
        <button class="join-btn with-video" id="join-with-video-btn" onclick="joinWithVideo()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          Join with Camera & Mic
        </button>
        <button class="join-btn watch-only" onclick="joinWatchOnly()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Watch Only
        </button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="member-header">
    <div class="header-inner">
      <a href="/home.html" class="header-logo">
        <img src="images/tmac-logo.png" alt="TMac Inspired">
        <span>The Tee Elite Circle</span>
      </a>
    </div>
  </header>

  <!-- MAIN -->
  <main class="member-main">
    <div class="live-container">
      <a href="/home.html" class="back-link">‚Üê Back to Dashboard</a>

      <div id="loading-state"><p style="color: #888; text-align: center; padding: 60px;">Checking live status...</p></div>

      <div id="not-live-state" style="display: none;">
        <div class="not-live">
          <div class="not-live-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></div>
          <h2>No Live Session Right Now</h2>
          <p>Dr. TMac isn't live at the moment. Check back soon!</p>
        </div>
      </div>

      <div id="live-state" style="display: none;">
        <div class="live-header">
          <div class="live-badge">Live Now</div>
          <h1 class="live-topic" id="live-topic">Live with Dr. TMac</h1>
        </div>

        <div class="live-wrapper">
          <div class="video-section">
            <div class="video-container">
              <video id="remote-video" autoplay playsinline></video>
              <div class="video-placeholder" id="video-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                <p>Connecting...</p>
              </div>
              <div class="local-preview" id="local-preview">
                <video id="local-video" autoplay muted playsinline></video>
              </div>
            </div>

            <div class="connection-status">
              <div class="status-left">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Ready</span>
              </div>
              <div class="viewer-controls">
                <button class="control-btn secondary" id="toggle-mic-btn" onclick="toggleMic()" style="display:none;" title="Toggle Microphone">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                </button>
                <button class="control-btn secondary" id="toggle-cam-btn" onclick="toggleCam()" style="display:none;" title="Toggle Camera">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                </button>
                <button class="control-btn secondary" onclick="leaveStream()" title="Leave">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                  Leave
                </button>
              </div>
            </div>
          </div>

          <aside class="chat-sidebar">
            <div class="chat-header"><h2 class="chat-title">Live Chat</h2></div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="chat-input" placeholder="Say something...">
              <button class="chat-send" onclick="sendChat()">Send</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </main>

  <script>
    const PEER_ID = 'viewer_' + Math.random().toString(36).substr(2, 9);
    let roomName = null;
    let peer = null;
    let memberName = 'Member';
    let localStream = null;
    let micEnabled = true;
    let camEnabled = true;

    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ];

    async function getMemberName() {
      try {
        const res = await fetch('/api/members/me');
        if (res.ok) { const m = await res.json(); memberName = m.name || 'Member'; }
      } catch (err) {}
    }

    async function checkLiveStatus() {
      try {
        const res = await fetch('/api/live/status');
        const status = await res.json();
        document.getElementById('loading-state').style.display = 'none';

        if (status.is_live && status.room_name) {
          roomName = status.room_name;
          document.getElementById('live-topic').textContent = status.topic || 'Live with Dr. TMac';
          document.getElementById('live-state').style.display = 'block';
          showJoinModal();
        } else {
          document.getElementById('not-live-state').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('not-live-state').style.display = 'block';
      }
    }

    async function showJoinModal() {
      document.getElementById('join-modal').classList.remove('hidden');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('preview-video').srcObject = stream;
        window.previewStream = stream;
      } catch (err) {
        document.getElementById('preview-container').innerHTML = '<p>Camera preview unavailable.<br>You can still watch!</p>';
        document.getElementById('join-with-video-btn').style.display = 'none';
      }
    }

    async function joinWithVideo() {
      document.getElementById('join-modal').classList.add('hidden');

      if (window.previewStream) {
        localStream = window.previewStream;
      } else {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        } catch (err) {
          alert('Could not access camera. Joining as watch-only.');
          joinWatchOnly();
          return;
        }
      }

      document.getElementById('local-video').srcObject = localStream;
      document.getElementById('local-preview').classList.add('visible');
      document.getElementById('toggle-mic-btn').style.display = 'flex';
      document.getElementById('toggle-cam-btn').style.display = 'flex';

      sendSystemMessage(`${memberName} joined with video üìπ`);
      connectToHost('join-video');
    }

    function joinWatchOnly() {
      document.getElementById('join-modal').classList.add('hidden');
      if (window.previewStream) {
        window.previewStream.getTracks().forEach(t => t.stop());
        window.previewStream = null;
      }
      sendSystemMessage(`${memberName} joined`);
      connectToHost('join');
    }

    async function connectToHost(signalType) {
      updateStatus('connecting', 'Connecting...');

      await fetch('/api/live/signal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          room_name: roomName,
          from_peer: PEER_ID,
          to_peer: 'host',
          signal_type: signalType,
          signal_data: '{}'
        })
      });

      pollForSignals();
      startChatPolling();
    }

    let isPolling = false;
    async function pollForSignals() {
      if (isPolling) return;
      isPolling = true;

      while (roomName) {
        try {
          const res = await fetch(`/api/live/signal?room_name=${roomName}&peer_id=${PEER_ID}`);
          const data = await res.json();

          for (const signal of data.signals || []) {
            if (signal.signal_type === 'offer') {
              createPeerConnection(JSON.parse(signal.signal_data));
            } else if (signal.signal_type === 'ice' && peer) {
              try { peer.signal(JSON.parse(signal.signal_data)); } catch (e) {}
            }
          }
        } catch (err) {}
        await new Promise(r => setTimeout(r, 1000));
      }
      isPolling = false;
    }

    function createPeerConnection(offerSignal) {
      if (peer) { peer.destroy(); peer = null; }

      const config = { initiator: false, trickle: true, config: { iceServers } };
      if (localStream) config.stream = localStream;

      peer = new SimplePeer(config);

      peer.on('signal', async (data) => {
        await fetch('/api/live/signal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            room_name: roomName,
            from_peer: PEER_ID,
            to_peer: 'host',
            signal_type: data.type === 'answer' ? 'answer' : 'ice',
            signal_data: JSON.stringify(data)
          })
        });
      });

      peer.on('stream', (stream) => {
        document.getElementById('remote-video').srcObject = stream;
        document.getElementById('video-placeholder').style.display = 'none';
        updateStatus('connected', 'Connected');
      });

      peer.on('connect', () => updateStatus('connected', 'Connected'));
      peer.on('close', () => { updateStatus('error', 'Disconnected'); peer = null; setTimeout(() => { if (roomName) location.reload(); }, 3000); });
      peer.on('error', (err) => { console.error('Peer error:', err); updateStatus('error', 'Error'); });

      peer.signal(offerSignal);
    }

    function toggleMic() {
      if (!localStream) return;
      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
      document.getElementById('toggle-mic-btn').classList.toggle('muted', !micEnabled);
    }

    function toggleCam() {
      if (!localStream) return;
      camEnabled = !camEnabled;
      localStream.getVideoTracks().forEach(t => t.enabled = camEnabled);
      document.getElementById('toggle-cam-btn').classList.toggle('muted', !camEnabled);
      document.getElementById('local-preview').classList.toggle('visible', camEnabled);
    }

    function leaveStream() {
      if (peer) peer.destroy();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      window.location.href = '/home.html';
    }

    function updateStatus(status, text) {
      document.getElementById('status-dot').className = 'status-dot ' + status;
      document.getElementById('status-text').textContent = text;
    }

    // Chat
    let lastChatId = 0, chatPolling = false;
    function startChatPolling() { if (!chatPolling) { chatPolling = true; pollChat(); } }
    async function pollChat() {
      if (!chatPolling || !roomName) return;
      try {
        const res = await fetch(`/api/live/chat?room_name=${roomName}&after_id=${lastChatId}`);
        const data = await res.json();
        for (const msg of data.messages || []) {
          if (msg.id > lastChatId) { addChatMessage(msg.author_name, msg.message); lastChatId = msg.id; }
        }
      } catch (err) {}
      setTimeout(pollChat, 2000);
    }

    function addChatMessage(author, text) {
      const c = document.getElementById('chat-messages');
      const d = document.createElement('div');
      d.className = 'chat-message';
      d.innerHTML = `<div class="chat-author">${author}</div><div class="chat-text">${text}</div>`;
      c.appendChild(d);
      c.scrollTop = c.scrollHeight;
    }

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg || !roomName) return;
      input.value = '';
      await fetch('/api/live/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ room_name: roomName, author_name: memberName, message: msg }) });
    }

    async function sendSystemMessage(message) {
      if (!roomName) return;
      await fetch('/api/live/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ room_name: roomName, author_name: 'System', message: message }) });
    }

    document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });

    getMemberName();
    checkLiveStatus();
  </script>
  <script src="/member-common.js"></script>
  <script src="/pwa-nav.js"></script>
</body>
</html>
