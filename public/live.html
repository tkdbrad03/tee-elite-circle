<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/images/tee-elite-favicon.png">
  <title>Live â€” The Tee Elite Circle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="pwa-nav.css">
  <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
  <style>
    :root {
      --tmac-blush: #e8ccc8;
      --tmac-bronze: #a67c52;
      --tmac-blush-light: #f7f0ef;
      --deep-forest: #1a2f23;
      --soft-cream: #FAF8F5;
      --charcoal: #2C2C2C;
    }

    .live-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--tmac-bronze);
      text-decoration: none;
      margin-bottom: 24px;
    }

    .back-link:hover {
      color: var(--deep-forest);
    }

    .back-link svg {
      width: 16px;
      height: 16px;
    }

    .live-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #c0392b;
      color: #fff;
      padding: 8px 16px;
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      animation: pulse 2s infinite;
    }

    .live-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .live-topic {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      color: var(--charcoal);
    }

    .live-wrapper {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }

    .video-section {
      display: flex;
      flex-direction: column;
    }

    .video-container {
      position: relative;
      background: #000;
      aspect-ratio: 16/9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #remote-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .video-placeholder {
      text-align: center;
      color: rgba(255,255,255,0.5);
    }

    .video-placeholder svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
    }

    .video-placeholder p {
      font-size: 14px;
    }

    .connection-status {
      padding: 12px 16px;
      background: #f0f0f0;
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #888;
    }

    .status-dot.connecting { background: #f39c12; animation: blink 1s infinite; }
    .status-dot.connected { background: #27ae60; }
    .status-dot.error { background: #c0392b; }

    .viewer-controls {
      display: flex;
      gap: 8px;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      font-family: 'Montserrat', sans-serif;
      font-size: 11px;
      letter-spacing: 0.05em;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .control-btn svg {
      width: 16px;
      height: 16px;
    }

    .join-btn {
      background: var(--deep-forest);
      color: #fff;
    }

    .join-btn:hover {
      background: var(--charcoal);
    }

    .join-btn.active {
      background: #c0392b;
    }

    .leave-btn {
      background: #f0f0f0;
      color: #666;
      border: 1px solid #ddd;
    }

    .leave-btn:hover {
      background: #e0e0e0;
      color: #333;
    }

    /* Local video preview (when joined) */
    .local-preview {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 150px;
      aspect-ratio: 16/9;
      background: #000;
      border: 2px solid var(--tmac-blush);
      border-radius: 4px;
      overflow: hidden;
      display: none;
    }

    .local-preview.visible {
      display: block;
    }

    .local-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Chat Sidebar */
    .chat-sidebar {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .chat-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 18px;
      color: var(--charcoal);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-message {
      margin-bottom: 16px;
    }

    .chat-author {
      font-size: 12px;
      font-weight: 500;
      color: var(--tmac-bronze);
      margin-bottom: 4px;
    }

    .chat-text {
      font-size: 14px;
      color: var(--charcoal);
      line-height: 1.5;
    }

    .chat-input-area {
      padding: 12px 16px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 10px 14px;
      font-family: 'Montserrat', sans-serif;
      font-size: 13px;
      border: 1px solid rgba(0,0,0,0.1);
      outline: none;
    }

    .chat-input:focus {
      border-color: var(--tmac-blush);
    }

    .chat-send {
      padding: 10px 16px;
      background: var(--deep-forest);
      color: #fff;
      border: none;
      font-family: 'Montserrat', sans-serif;
      font-size: 12px;
      cursor: pointer;
    }

    .chat-send:hover {
      background: var(--charcoal);
    }

    /* Not Live State */
    .not-live {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
      text-align: center;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .not-live-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--tmac-blush-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }

    .not-live-icon svg {
      width: 40px;
      height: 40px;
      stroke: var(--tmac-bronze);
    }

    .not-live h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      color: var(--charcoal);
      margin-bottom: 12px;
    }

    .not-live p {
      font-size: 15px;
      color: #666;
      max-width: 400px;
      line-height: 1.7;
    }

    .check-btn {
      margin-top: 24px;
      display: inline-block;
      font-family: 'Montserrat', sans-serif;
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--charcoal);
      background: var(--tmac-blush);
      border: none;
      padding: 14px 28px;
      cursor: pointer;
    }

    .check-btn:hover {
      background: var(--tmac-blush-light);
    }

    @media (max-width: 900px) {
      .live-wrapper {
        grid-template-columns: 1fr;
      }
      .chat-sidebar {
        height: 350px;
      }
    }
  </style>
</head>
<body class="member-body">
  
  <!-- HEADER -->
  <header class="member-header">
    <div class="header-inner">
      <a href="/home.html" class="header-logo">
        <img src="images/tmac-logo.png" alt="TMac Inspired">
        <span>The Tee Elite Circle</span>
      </a>
      <nav class="header-nav">
        <a href="/home.html" class="nav-link">Home</a>
        <a href="/members.html" class="nav-link">The Circle</a>
        <a href="/retreats.html" class="nav-link">Retreats</a>
        <a href="/resources.html" class="nav-link">Tee Room</a>
      </nav>
      <div class="header-user">
        <a href="/profile.html" class="user-avatar" id="user-avatar">
          <span id="user-initials">FM</span>
        </a>
      </div>
      <button class="mobile-menu-btn" id="mobile-menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- MOBILE NAV -->
  <div class="mobile-nav" id="mobile-nav">
    <a href="/home.html" class="mobile-nav-link">Home</a>
    <a href="/members.html" class="mobile-nav-link">The Circle</a>
    <a href="/retreats.html" class="mobile-nav-link">Retreats</a>
    <a href="/resources.html" class="mobile-nav-link">Tee Room</a>
    <a href="/profile.html" class="mobile-nav-link">My Profile</a>
    <a href="#" class="mobile-nav-link logout-link" id="logout-link">Log Out</a>
  </div>

  <!-- MAIN -->
  <main class="member-main">
    <div class="live-container">
      <a href="/home.html" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
      </a>

      <!-- Loading -->
      <div id="loading-state">
        <p style="color: #888; text-align: center; padding: 60px;">Checking live status...</p>
      </div>

      <!-- Not Live -->
      <div id="not-live-state" style="display: none;">
        <div class="not-live">
          <div class="not-live-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M23 7l-7 5 7 5V7z"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </svg>
          </div>
          <h2>No Live Session Right Now</h2>
          <p>Dr. TMac isn't live at the moment. Check back soon or keep an eye on your dashboard for the ðŸ”´ Live indicator.</p>
          <button class="check-btn" onclick="checkLiveStatus()">Check Again</button>
        </div>
      </div>

      <!-- Live View -->
      <div id="live-state" style="display: none;">
        <div class="live-header">
          <div class="live-badge">Live Now</div>
          <h1 class="live-topic" id="live-topic">Live with Dr. TMac</h1>
        </div>

        <div class="live-wrapper">
          <div class="video-section">
            <div class="video-container" id="video-container">
              <video id="remote-video" autoplay playsinline></video>
              <div class="video-placeholder" id="video-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M23 7l-7 5 7 5V7z"/>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                <p>Connecting to stream...</p>
              </div>
              <div class="local-preview" id="local-preview">
                <video id="local-video" autoplay muted playsinline></video>
              </div>
            </div>
            <div class="connection-status">
              <div class="status-left">
                <span class="status-dot connecting" id="status-dot"></span>
                <span id="status-text">Connecting...</span>
              </div>
              <div class="viewer-controls">
                <button class="control-btn join-btn" id="join-call-btn" onclick="toggleJoinCall()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 7l-7 5 7 5V7z"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                  </svg>
                  <span id="join-btn-text">Join Call</span>
                </button>
                <button class="control-btn leave-btn" onclick="leaveStream()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                  </svg>
                  Leave
                </button>
              </div>
            </div>
          </div>

          <aside class="chat-sidebar">
            <div class="chat-header">
              <h2 class="chat-title">Live Chat</h2>
            </div>
            <div class="chat-messages" id="chat-messages">
              <div class="chat-message">
                <div class="chat-author">The Tee Elite Circle</div>
                <div class="chat-text">Welcome to the live session! Feel free to drop questions in the chat.</div>
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="chat-input" placeholder="Say something...">
              <button class="chat-send" id="chat-send">Send</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="member-footer">
    <p>The Tee Elite Circle â€” A TMac Inspired Experience</p>
  </footer>

  <script>
    // Mobile menu
    document.getElementById('mobile-menu-btn').addEventListener('click', function() {
      this.classList.toggle('active');
      document.getElementById('mobile-nav').classList.toggle('open');
    });

    // === CONFIG ===
    const PEER_ID = 'viewer_' + Math.random().toString(36).substr(2, 9);
    let roomName = null;
    let peer = null;
    let memberName = 'Member';
    let localStream = null;
    let hasJoinedCall = false;

    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' }
    ];

    // === GET MEMBER NAME ===
    async function getMemberName() {
      try {
        const res = await fetch('/api/members/me');
        if (res.ok) {
          const member = await res.json();
          memberName = member.name || 'Member';
          document.getElementById('user-initials').textContent = getInitials(member.name);
        }
      } catch (err) {}
    }

    function getInitials(name) {
      if (!name) return 'FM';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    // === CHECK LIVE STATUS ===
    async function checkLiveStatus() {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('not-live-state').style.display = 'none';
      document.getElementById('live-state').style.display = 'none';

      try {
        const res = await fetch('/api/live/status');
        if (!res.ok) throw new Error('Failed to check');

        const status = await res.json();
        document.getElementById('loading-state').style.display = 'none';

        if (status.is_live && status.room_name) {
          roomName = status.room_name;
          document.getElementById('live-topic').textContent = status.topic || 'Live with Dr. TMac';
          document.getElementById('live-state').style.display = 'block';
          
          // Connect to stream
          joinStream();
        } else {
          document.getElementById('not-live-state').style.display = 'block';
        }
      } catch (err) {
        console.error('Status check error:', err);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('not-live-state').style.display = 'block';
      }
    }

    // === JOIN STREAM ===
    async function joinStream() {
      updateStatus('connecting', 'Connecting...');

      // Start chat polling
      startChatPolling();

      // Tell host we want to join
      await fetch('/api/live/signal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          room_name: roomName,
          from_peer: PEER_ID,
          to_peer: 'host',
          signal_type: 'join',
          signal_data: '{}'
        })
      });

      // Poll for host's offer
      pollForSignals();
    }

    // === POLL FOR SIGNALS ===
    async function pollForSignals() {
      try {
        const res = await fetch(`/api/live/signal?room_name=${roomName}&peer_id=${PEER_ID}`);
        const data = await res.json();

        for (const signal of data.signals || []) {
          if (signal.signal_type === 'offer') {
            // Host sent offer - create peer and answer
            createPeerConnection(JSON.parse(signal.signal_data));
          } else if (signal.signal_type === 'ice' && peer) {
            // ICE candidate from host
            peer.signal(JSON.parse(signal.signal_data));
          }
        }
      } catch (err) {
        console.error('Poll error:', err);
      }

      // Keep polling
      setTimeout(pollForSignals, 1000);
    }

    // === CREATE PEER (VIEWER RECEIVES) ===
    function createPeerConnection(offerSignal) {
      if (peer) return;

      // Include local stream if viewer has joined with video
      const peerConfig = {
        initiator: false,
        trickle: true,
        config: { iceServers }
      };

      // Add local stream if we have one (joined with video)
      if (localStream) {
        peerConfig.stream = localStream;
      }

      peer = new SimplePeer(peerConfig);

      peer.on('signal', async (signalData) => {
        // Send answer/ICE back to host
        const signalType = signalData.type === 'answer' ? 'answer' : 'ice';
        await fetch('/api/live/signal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            room_name: roomName,
            from_peer: PEER_ID,
            to_peer: 'host',
            signal_type: signalType,
            signal_data: JSON.stringify(signalData)
          })
        });
      });

      peer.on('stream', (stream) => {
        console.log('Received stream!');
        const video = document.getElementById('remote-video');
        video.srcObject = stream;
        document.getElementById('video-placeholder').style.display = 'none';
        updateStatus('connected', 'Connected');
      });

      peer.on('connect', () => {
        console.log('Peer connected');
        updateStatus('connected', 'Connected');
      });

      peer.on('close', () => {
        console.log('Connection closed');
        updateStatus('error', 'Connection lost');
        peer = null;
        // Try to reconnect
        setTimeout(joinStream, 3000);
      });

      peer.on('error', (err) => {
        console.error('Peer error:', err);
        updateStatus('error', 'Connection error');
      });

      // Process the offer
      peer.signal(offerSignal);
    }

    // === STATUS HELPERS ===
    function updateStatus(status, text) {
      const dot = document.getElementById('status-dot');
      dot.className = 'status-dot ' + status;
      document.getElementById('status-text').textContent = text;
    }

    // === LEAVE STREAM ===
    function leaveStream() {
      // Disconnect peer
      if (peer) {
        peer.destroy();
        peer = null;
      }

      // Stop local stream if active
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      // Redirect back to dashboard
      window.location.href = '/home.html';
    }

    // === JOIN CALL (with camera/mic) ===
    async function toggleJoinCall() {
      const btn = document.getElementById('join-call-btn');
      const btnText = document.getElementById('join-btn-text');
      const localPreview = document.getElementById('local-preview');

      if (hasJoinedCall) {
        // Leave the call (stop camera)
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }

        localPreview.classList.remove('visible');
        btn.classList.remove('active');
        btnText.textContent = 'Join Call';
        hasJoinedCall = false;

        // Reconnect without video
        if (peer) {
          peer.destroy();
          peer = null;
        }
        joinStream();
        
      } else {
        // Join the call (start camera)
        try {
          // Request both video AND audio explicitly
          localStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 640 },
              height: { ideal: 480 }
            },
            audio: {
              echoCancellation: true,
              noiseSuppression: true
            }
          });

          // Verify we got audio
          const audioTracks = localStream.getAudioTracks();
          const videoTracks = localStream.getVideoTracks();
          console.log('Got audio tracks:', audioTracks.length, 'video tracks:', videoTracks.length);

          if (audioTracks.length === 0) {
            console.warn('No audio track - trying to get audio separately');
            try {
              const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
              audioStream.getAudioTracks().forEach(track => localStream.addTrack(track));
            } catch (audioErr) {
              console.error('Could not get audio:', audioErr);
            }
          }

          // Show local preview
          document.getElementById('local-video').srcObject = localStream;
          localPreview.classList.add('visible');

          btn.classList.add('active');
          btnText.textContent = 'Leave Call';
          hasJoinedCall = true;

          // Destroy old peer and create new one with our stream
          if (peer) {
            peer.destroy();
            peer = null;
          }

          // Notify in chat
          await fetch('/api/live/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              room_name: roomName,
              author_name: 'System',
              message: `${memberName} joined the call with video ðŸ“¹`
            })
          });

          // Rejoin with our video stream
          joinStreamWithVideo();

        } catch (err) {
          console.error('Camera access error:', err);
          alert('Could not access camera/microphone. Please check permissions.');
        }
      }
    }

    // Join stream WITH video (viewer sends their stream too)
    async function joinStreamWithVideo() {
      updateStatus('connecting', 'Connecting with video...');

      // Tell host we want to join with video
      await fetch('/api/live/signal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          room_name: roomName,
          from_peer: PEER_ID,
          to_peer: 'host',
          signal_type: 'join-video',
          signal_data: '{}'
        })
      });

      // Poll for host's offer
      pollForSignals();
    }

    // === CHAT ===
    let lastChatId = 0;
    let chatPolling = false;

    document.getElementById('chat-send').addEventListener('click', sendChat);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message || !roomName) return;

      input.value = '';

      // Send to server
      try {
        await fetch('/api/live/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            room_name: roomName,
            author_name: memberName,
            message: message
          })
        });
      } catch (err) {
        console.error('Chat send error:', err);
      }
    }

    async function pollChat() {
      if (!roomName || !chatPolling) return;

      try {
        const url = `/api/live/chat?room_name=${roomName}${lastChatId ? `&after_id=${lastChatId}` : ''}`;
        const res = await fetch(url);
        const data = await res.json();

        for (const msg of data.messages || []) {
          if (msg.id > lastChatId) {
            addChatMessage(msg.author_name, msg.message);
            lastChatId = msg.id;
          }
        }
      } catch (err) {
        console.error('Chat poll error:', err);
      }

      // Poll again
      setTimeout(pollChat, 2000);
    }

    function startChatPolling() {
      if (!chatPolling) {
        chatPolling = true;
        // Clear the welcome message
        document.getElementById('chat-messages').innerHTML = '';
        pollChat();
      }
    }

    function addChatMessage(author, text) {
      const container = document.getElementById('chat-messages');
      const msgEl = document.createElement('div');
      msgEl.className = 'chat-message';
      msgEl.innerHTML = `
        <div class="chat-author">${author}</div>
        <div class="chat-text">${text}</div>
      `;
      container.appendChild(msgEl);
      container.scrollTop = container.scrollHeight;
    }

    // === INIT ===
    getMemberName();
    checkLiveStatus();

    // Poll for live status if not live
    setInterval(() => {
      if (document.getElementById('not-live-state').style.display !== 'none') {
        checkLiveStatus();
      }
    }, 30000);
  </script>
  <script src="/member-common.js"></script>
  <script src="/pwa-nav.js"></script>
</body>
</html>
