<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/images/tee-elite-favicon.png">
  <title>Email Campaign ‚Äî The Tee Elite Circle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --tmac-blush: #e8ccc8;
      --tmac-bronze: #a67c52;
      --tmac-blush-light: #f7f0ef;
      --deep-forest: #1a2f23;
      --soft-cream: #FAF8F5;
      --charcoal: #2C2C2C;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--soft-cream);
      color: var(--charcoal);
      min-height: 100vh;
    }

    .admin-header {
      background: var(--deep-forest);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px;
      color: #fff;
    }

    .admin-header a {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 13px;
    }

    .campaign-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .card {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      padding: 32px;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--tmac-bronze);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 8px;
      color: #555;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 14px 16px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
      outline: none;
      margin-bottom: 20px;
    }

    input[type="text"]:focus, textarea:focus {
      border-color: var(--tmac-bronze);
    }

    textarea {
      min-height: 200px;
      resize: vertical;
      line-height: 1.6;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .checkbox-wrapper input {
      width: 18px;
      height: 18px;
      accent-color: var(--deep-forest);
    }

    .checkbox-wrapper label { margin: 0; font-size: 14px; }

    .btn {
      padding: 14px 32px;
      font-family: 'Montserrat', sans-serif;
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--deep-forest);
      color: #fff;
    }

    .btn-primary:hover { background: var(--charcoal); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

    .btn-secondary {
      background: var(--tmac-blush);
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      background: var(--tmac-bronze);
      color: #fff;
    }

    .btn-danger {
      background: #c0392b;
      color: #fff;
    }

    .contacts-preview {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .contacts-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .contacts-table th {
      background: var(--tmac-blush-light);
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      position: sticky;
      top: 0;
    }

    .contacts-table td {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .contact-count {
      font-size: 14px;
      color: var(--tmac-bronze);
      margin-bottom: 16px;
    }

    .email-preview {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 24px;
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    .preview-header {
      background: var(--tmac-blush-light);
      padding: 12px 16px;
      margin: -24px -24px 24px -24px;
      font-size: 12px;
      color: #666;
    }

    .status {
      padding: 16px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .status.success { background: #d4edda; color: #155724; display: block; }
    .status.error { background: #f8d7da; color: #721c24; display: block; }
    .status.sending { background: var(--tmac-blush-light); color: var(--charcoal); display: block; }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-fill {
      height: 100%;
      background: var(--deep-forest);
      width: 0%;
      transition: width 0.3s;
    }

    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .tab {
      padding: 14px 24px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
    }

    .tab:hover { color: var(--tmac-bronze); }
    .tab.active { border-bottom-color: var(--deep-forest); font-weight: 500; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .actions-row {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .drop-zone {
      border: 2px dashed rgba(0,0,0,0.15);
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--tmac-bronze);
      background: var(--tmac-blush-light);
    }

    .drop-zone p { font-size: 14px; color: #666; }
    .drop-zone .icon { font-size: 32px; margin-bottom: 12px; }

    .helper-text {
      font-size: 12px;
      color: #888;
      margin-top: -12px;
      margin-bottom: 20px;
    }

    .progress-details {
      margin-top: 16px;
      padding: 16px;
      background: var(--tmac-blush-light);
      font-size: 13px;
    }

    .progress-details .stat {
      display: inline-block;
      margin-right: 24px;
    }

    .progress-details .stat.sent { color: #27ae60; }
    .progress-details .stat.failed { color: #c0392b; }

    .time-estimate {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #856404;
    }
  </style>
</head>
<body>

  <header class="admin-header">
    <h1>Email Campaign</h1>
    <a href="/admin.html">‚Üê Back to Admin</a>
  </header>

  <div class="campaign-container">

    <div id="statusMessage" class="status"></div>

    <!-- Step 1: Contacts -->
    <div class="card">
      <div class="card-title">Step 1: Add Contacts</div>
      
      <div class="tabs">
        <div class="tab active" data-tab="upload">Upload CSV</div>
        <div class="tab" data-tab="paste">Paste List</div>
      </div>

      <div id="upload-tab" class="tab-content active">
        <div class="drop-zone" id="dropZone">
          <div class="icon">üìÅ</div>
          <p>Drop your CSV file here, or click to select</p>
          <p style="font-size: 12px; color: #999; margin-top: 8px;">File must have columns: first_name, email</p>
        </div>
        <input type="file" id="csvFile" accept=".csv" style="display: none;">
      </div>

      <div id="paste-tab" class="tab-content">
        <label>Paste contacts (one per line: name, email)</label>
        <textarea id="pasteContacts" placeholder="Brandy, brandy@example.com&#10;Pattie, pattie@example.com"></textarea>
        <button class="btn btn-secondary" onclick="parsePastedContacts()">Parse Contacts</button>
      </div>

      <div id="contactsCount" class="contact-count" style="display: none;"></div>
      
      <div id="contactsPreview" class="contacts-preview" style="display: none;">
        <table class="contacts-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="contactsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Step 2: Compose Email -->
    <div class="card">
      <div class="card-title">Step 2: Compose Email</div>
      
      <label>Subject Line</label>
      <input type="text" id="emailSubject" placeholder="It's been a minute...">

      <label>Email Body</label>
      <p class="helper-text">Use {first_name} to personalize. It will be replaced with each contact's name.</p>
      <textarea id="emailTemplate" placeholder="Hey {first_name},

Girl, it's been a minute. Hope you're doing well!

So... I started golfing. Random, I know. But I'm obsessed now and I had to tell you why.

The people I'm meeting on the golf course? Business owners. Investors. Retired folks who already made it. More real connections than any networking event I've ever been to. I didn't expect that.

I'm putting together something called The Tee Elite Circle, a space for women who want in on this. You don't have to know how to play. Just be curious.

It's brand new, so you'd literally be getting in at the beginning.

No pressure at all. I just thought of you and wanted to share.

Let me know if you want the details. üèåüèæ‚Äç‚ôÄÔ∏è

Dr. TMac"></textarea>

      <div class="checkbox-wrapper">
        <input type="checkbox" id="useBranding" checked>
        <label for="useBranding">Use Tee Elite Circle branded template (header & footer)</label>
      </div>

      <button class="btn btn-secondary" onclick="showPreview()">Preview Email</button>

      <div id="previewContainer" style="display: none;">
        <div class="email-preview">
          <div class="preview-header">
            <strong>To:</strong> <span id="previewTo"></span><br>
            <strong>Subject:</strong> <span id="previewSubject"></span>
          </div>
          <div id="previewBody"></div>
        </div>
      </div>
    </div>

    <!-- Step 3: Send -->
    <div class="card">
      <div class="card-title">Step 3: Send Campaign</div>
      
      <div class="warning-box">
        ‚ö†Ô∏è <strong>Gmail Rate Limits:</strong> Emails are sent in small batches (10 at a time) with 30-second pauses between batches to avoid Gmail blocking. For 500 contacts, expect ~25-30 minutes. <strong>Keep this tab open.</strong>
      </div>

      <div class="actions-row">
        <button class="btn btn-primary" id="sendBtn" onclick="sendCampaign()" disabled>
          Send to <span id="sendCount">0</span> Contacts
        </button>
        <button class="btn btn-danger" id="stopBtn" onclick="stopCampaign()" style="display: none;">
          Stop Sending
        </button>
      </div>

      <div id="progressSection" style="display: none; margin-top: 24px;">
        <div id="progressStatus" style="font-size: 14px; margin-bottom: 8px; color: var(--tmac-bronze); font-weight: 500;"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-details">
          <span class="stat sent">‚úì Sent: <strong id="sentCount">0</strong></span>
          <span class="stat failed">‚úó Failed: <strong id="failedCount">0</strong></span>
          <span class="stat">Remaining: <strong id="remainingCount">0</strong></span>
        </div>
        <div class="time-estimate" id="timeEstimate"></div>
      </div>

      <div id="reportSection" style="display: none; margin-top: 24px;">
        <div class="card-title" style="margin-top: 0;">Campaign Report</div>
        <div id="reportSummary" style="font-size: 14px; margin-bottom: 16px;"></div>
        
        <div class="actions-row" style="margin-top: 0;">
          <button class="btn btn-secondary" onclick="downloadReport()">üì• Download Report (CSV)</button>
          <button class="btn btn-secondary" onclick="retryFailed()" id="retryBtn" style="display: none;">üîÑ Retry Failed Emails</button>
        </div>
        
        <div id="failedList" style="display: none; margin-top: 20px;">
          <p style="font-size: 13px; color: #c0392b; font-weight: 500; margin-bottom: 8px;">Failed Emails:</p>
          <div id="failedEmails" style="font-size: 12px; color: #555; max-height: 150px; overflow-y: auto; background: #f8d7da; padding: 12px;"></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    let contacts = [];
    let campaignResults = null;
    let isSending = false;
    let shouldStop = false;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // Drag and drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('csvFile');

    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) parseCSV(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) parseCSV(file);
    });

    function parseCSV(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split('\n');
        contacts = [];

        const columns = parseCSVLine(lines[0]);
        let firstNameIdx = -1, emailIdx = -1;

        columns.forEach((col, idx) => {
          const colLower = col.toLowerCase().trim();
          if (['first_name', 'first name', 'name', 'firstname'].includes(colLower)) firstNameIdx = idx;
          if (['email', 'email_address', 'email address'].includes(colLower)) emailIdx = idx;
        });

        if (emailIdx === -1) {
          showStatus('error', 'CSV must have an "email" column');
          return;
        }

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const cols = parseCSVLine(lines[i]);
          const email = cols[emailIdx]?.trim();
          const firstName = firstNameIdx >= 0 ? cols[firstNameIdx]?.trim() : '';

          if (email && email.includes('@')) {
            contacts.push({ first_name: firstName || '', email: email });
          }
        }

        displayContacts();
      };
      reader.readAsText(file);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '', inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function parsePastedContacts() {
      const text = document.getElementById('pasteContacts').value;
      const lines = text.split('\n');
      contacts = [];

      lines.forEach(line => {
        if (!line.trim()) return;
        const parts = line.split(',');
        if (parts.length >= 2) {
          const firstName = parts[0].trim();
          const email = parts[1].trim();
          if (email.includes('@')) contacts.push({ first_name: firstName, email: email });
        }
      });

      displayContacts();
    }

    function displayContacts() {
      const tbody = document.getElementById('contactsBody');
      const countEl = document.getElementById('contactsCount');
      const previewEl = document.getElementById('contactsPreview');
      const sendBtn = document.getElementById('sendBtn');
      const sendCount = document.getElementById('sendCount');

      if (contacts.length === 0) {
        showStatus('error', 'No valid contacts found');
        return;
      }

      tbody.innerHTML = contacts.map((c, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${c.first_name || '(no name)'}</td>
          <td>${c.email}</td>
        </tr>
      `).join('');

      const estimatedMins = Math.ceil((contacts.length / 10) * 0.5);
      countEl.innerHTML = `${contacts.length} contacts loaded <span style="color: #888; font-size: 12px;">(~${estimatedMins} minutes to send)</span>`;
      countEl.style.display = 'block';
      previewEl.style.display = 'block';
      sendCount.textContent = contacts.length;
      sendBtn.disabled = false;

      showStatus('success', `Loaded ${contacts.length} contacts`);
    }

    function showPreview() {
      const subject = document.getElementById('emailSubject').value;
      const template = document.getElementById('emailTemplate').value;

      if (!subject || !template) {
        showStatus('error', 'Please fill in subject and email body');
        return;
      }

      const sampleName = contacts.length > 0 ? contacts[0].first_name || 'there' : 'there';
      const sampleEmail = contacts.length > 0 ? contacts[0].email : 'example@email.com';

      document.getElementById('previewTo').textContent = sampleEmail;
      document.getElementById('previewSubject').textContent = subject;
      document.getElementById('previewBody').textContent = template.replace(/{first_name}/gi, sampleName);
      document.getElementById('previewContainer').style.display = 'block';
    }

    async function sendCampaign() {
      const subject = document.getElementById('emailSubject').value;
      const template = document.getElementById('emailTemplate').value;
      const useTemplate = document.getElementById('useBranding').checked;

      if (!subject || !template) {
        showStatus('error', 'Please fill in subject and email body');
        return;
      }

      if (contacts.length === 0) {
        showStatus('error', 'No contacts loaded');
        return;
      }

      if (!confirm(`Send ${contacts.length} emails?\n\nThis will take approximately ${Math.ceil((contacts.length / 10) * 0.5)} minutes.\n\nKeep this tab open until complete.`)) {
        return;
      }

      // Setup UI
      isSending = true;
      shouldStop = false;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('sendBtn').textContent = 'Sending...';
      document.getElementById('stopBtn').style.display = 'inline-block';
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('reportSection').style.display = 'none';

      // Reset results
      campaignResults = {
        sent: 0,
        failed: 0,
        details: [],
        subject: subject,
        timestamp: new Date().toISOString()
      };

      // Batch settings - 10 emails per batch, 30 second pause between batches
      const BATCH_SIZE = 10;
      const BATCH_DELAY = 30000; // 30 seconds
      const totalBatches = Math.ceil(contacts.length / BATCH_SIZE);

      for (let batch = 0; batch < totalBatches; batch++) {
        if (shouldStop) {
          showStatus('error', 'Campaign stopped by user');
          break;
        }

        const start = batch * BATCH_SIZE;
        const end = Math.min(start + BATCH_SIZE, contacts.length);
        const batchContacts = contacts.slice(start, end);

        // Update progress UI
        updateProgress(start, end, contacts.length, batch + 1, totalBatches);

        try {
          const response = await fetch('/api/admin/email-campaign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contacts: batchContacts,
              subject,
              template,
              useTemplate
            })
          });

          const data = await response.json();

          if (data.success) {
            campaignResults.sent += data.results.sent;
            campaignResults.failed += data.results.failed;
            campaignResults.details = campaignResults.details.concat(data.results.details);
          } else {
            // API error - mark all as failed
            batchContacts.forEach(c => {
              campaignResults.failed++;
              campaignResults.details.push({
                email: c.email,
                name: c.first_name,
                status: 'failed',
                error: data.error || 'API error',
                timestamp: new Date().toISOString()
              });
            });
          }
        } catch (err) {
          batchContacts.forEach(c => {
            campaignResults.failed++;
            campaignResults.details.push({
              email: c.email,
              name: c.first_name,
              status: 'failed',
              error: err.message,
              timestamp: new Date().toISOString()
            });
          });
        }

        // Update counts
        document.getElementById('sentCount').textContent = campaignResults.sent;
        document.getElementById('failedCount').textContent = campaignResults.failed;
        document.getElementById('remainingCount').textContent = contacts.length - end;

        // Wait between batches (except for last batch)
        if (batch < totalBatches - 1 && !shouldStop) {
          await countdownDelay(BATCH_DELAY, batch + 1, totalBatches);
        }
      }

      // Complete
      isSending = false;
      document.getElementById('progressStatus').textContent = shouldStop 
        ? `‚ö†Ô∏è Stopped. ${campaignResults.sent} sent, ${campaignResults.failed} failed`
        : `‚úì Complete! ${campaignResults.sent} sent, ${campaignResults.failed} failed`;
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('sendBtn').textContent = `Send to ${contacts.length} Contacts`;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('timeEstimate').textContent = '';

      showReport();
    }

    function updateProgress(start, end, total, currentBatch, totalBatches) {
      const percent = (end / total) * 100;
      document.getElementById('progressStatus').textContent = `Sending batch ${currentBatch} of ${totalBatches} (emails ${start + 1}-${end})...`;
      document.getElementById('progressFill').style.width = `${percent}%`;
      document.getElementById('remainingCount').textContent = total - start;
      
      const remainingBatches = totalBatches - currentBatch;
      const estimatedMins = Math.ceil(remainingBatches * 0.5);
      document.getElementById('timeEstimate').textContent = `Estimated time remaining: ~${estimatedMins} minutes`;
    }

    async function countdownDelay(ms, currentBatch, totalBatches) {
      const seconds = ms / 1000;
      for (let i = seconds; i > 0; i--) {
        if (shouldStop) return;
        document.getElementById('progressStatus').textContent = `Batch ${currentBatch} done. Waiting ${i}s before next batch...`;
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    function stopCampaign() {
      if (confirm('Stop sending? Emails already sent cannot be undone.')) {
        shouldStop = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('stopBtn').textContent = 'Stopping...';
      }
    }

    function showReport() {
      const reportSection = document.getElementById('reportSection');
      const reportSummary = document.getElementById('reportSummary');
      const failedList = document.getElementById('failedList');
      const failedEmails = document.getElementById('failedEmails');
      const retryBtn = document.getElementById('retryBtn');

      reportSection.style.display = 'block';
      
      reportSummary.innerHTML = `
        <div style="display: flex; gap: 24px; margin-bottom: 8px;">
          <span style="color: #27ae60;">‚úì Sent: <strong>${campaignResults.sent}</strong></span>
          <span style="color: #c0392b;">‚úó Failed: <strong>${campaignResults.failed}</strong></span>
          <span style="color: #555;">Total: <strong>${campaignResults.sent + campaignResults.failed}</strong></span>
        </div>
        <div style="font-size: 12px; color: #888;">Campaign completed at ${new Date().toLocaleString()}</div>
      `;

      if (campaignResults.failed > 0) {
        const failed = campaignResults.details.filter(d => d.status === 'failed');
        failedEmails.innerHTML = failed.map(f => `${f.email} - ${f.error || 'Unknown error'}`).join('<br>');
        failedList.style.display = 'block';
        retryBtn.style.display = 'inline-block';
      } else {
        failedList.style.display = 'none';
        retryBtn.style.display = 'none';
      }
    }

    function retryFailed() {
      const failed = campaignResults.details.filter(d => d.status === 'failed');
      contacts = failed.map(f => ({ first_name: f.name, email: f.email }));
      displayContacts();
      showStatus('success', `Loaded ${contacts.length} failed contacts for retry`);
      document.getElementById('reportSection').style.display = 'none';
      document.getElementById('progressSection').style.display = 'none';
    }

    function downloadReport() {
      if (!campaignResults || !campaignResults.details.length) {
        alert('No report data available');
        return;
      }

      const headers = ['Email', 'Name', 'Status', 'Error', 'Timestamp'];
      const rows = campaignResults.details.map(d => [
        d.email,
        d.name || '',
        d.status,
        d.error || '',
        d.timestamp
      ]);

      let csvContent = headers.join(',') + '\n';
      rows.forEach(row => {
        csvContent += row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(',') + '\n';
      });

      csvContent += '\n';
      csvContent += `"Campaign Subject","${campaignResults.subject}"\n`;
      csvContent += `"Total Sent","${campaignResults.sent}"\n`;
      csvContent += `"Total Failed","${campaignResults.failed}"\n`;
      csvContent += `"Campaign Date","${campaignResults.timestamp}"\n`;

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', `email-campaign-report-${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showStatus(type, message) {
      const el = document.getElementById('statusMessage');
      el.className = 'status ' + type;
      el.textContent = message;
    }
  </script>

</body>
</html>
