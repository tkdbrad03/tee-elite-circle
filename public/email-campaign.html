<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/images/tee-elite-favicon.png">
  <title>Email Campaign ‚Äî The Tee Elite Circle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
  <style>
    :root {
      --tmac-blush: #e8ccc8;
      --tmac-bronze: #a67c52;
      --tmac-blush-light: #f7f0ef;
      --deep-forest: #1a2f23;
      --soft-cream: #faf7f5;
      --paper: #ffffff;
      --charcoal: #2a2422;
      --muted: rgba(0,0,0,0.55);
      --danger: #b84b4b;
      --success: #2c7a4b;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--soft-cream);
      color: var(--charcoal);
      min-height: 100vh;
    }

    .admin-header {
      background: var(--deep-forest);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-header h1 {
      margin: 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px;
      color: #fff;
    }

    .admin-header a {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 13px;
    }

    .campaign-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .card {
      background: var(--paper);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 8px;
      padding: 22px 22px;
      margin-bottom: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .card-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 18px;
      margin-bottom: 14px;
      color: var(--deep-forest);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .tab {
      padding: 10px 14px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px;
      user-select: none;
    }

    .tab.active {
      border-color: var(--deep-forest);
      background: rgba(26,47,35,0.06);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .drop-zone {
      border: 2px dashed rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.6);
      padding: 24px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
    }

    .drop-zone.dragover {
      border-color: var(--deep-forest);
      background: rgba(26,47,35,0.06);
    }

    .drop-zone .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .helper-text {
      font-size: 13px;
      margin-bottom: 8px;
      color: #555;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 14px 16px;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
      outline: none;
      margin-bottom: 20px;
      box-sizing: border-box;
      border-radius: 6px;
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: rgba(0,0,0,0.7);
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease;
      font-size: 13px;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--deep-forest);
      color: #fff;
    }

    .btn-secondary {
      background: var(--tmac-blush);
      color: var(--deep-forest);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .status {
      display: none;
      padding: 12px 14px;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .status.success {
      display: block;
      background: rgba(44,122,75,0.1);
      border-color: rgba(44,122,75,0.25);
      color: var(--success);
    }

    .status.error {
      display: block;
      background: rgba(184,75,75,0.1);
      border-color: rgba(184,75,75,0.25);
      color: var(--danger);
    }

    .contacts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }

    .contacts-table th, .contacts-table td {
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 10px 8px;
      text-align: left;
    }

    .contacts-table th {
      font-size: 12px;
      color: rgba(0,0,0,0.6);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0 18px;
      font-size: 13px;
      color: rgba(0,0,0,0.65);
    }

    .checkbox-wrapper input {
      width: 16px;
      height: 16px;
    }

    .warn-box {
      background: rgba(166,124,82,0.12);
      border: 1px solid rgba(166,124,82,0.25);
      padding: 14px;
      border-radius: 10px;
      margin-top: 12px;
      color: rgba(0,0,0,0.7);
      font-size: 13px;
      line-height: 1.5;
    }

    .progress {
      margin-top: 12px;
      font-size: 13px;
      color: rgba(0,0,0,0.65);
    }

    .results {
      display: none;
      margin-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.08);
      padding-top: 16px;
    }

    .results.visible {
      display: block;
    }

    .results h3 {
      margin: 0 0 10px;
      font-family: 'Cormorant Garamond', serif;
      color: var(--deep-forest);
    }

    .results .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
    }

    .pill.success {
      color: var(--success);
      border-color: rgba(44,122,75,0.3);
      background: rgba(44,122,75,0.08);
    }

    .pill.error {
      color: var(--danger);
      border-color: rgba(184,75,75,0.3);
      background: rgba(184,75,75,0.08);
    }

    /* Preview modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 22px;
      z-index: 9999;
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      border: 1px solid rgba(0,0,0,0.12);
    }

    .modal-topbar {
      background: var(--deep-forest);
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.85);
      font-size: 18px;
      cursor: pointer;
    }

    .modal-body {
      padding: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--charcoal);
    }

    .preview-header {
      font-size: 13px;
      color: rgba(0,0,0,0.65);
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    /* --- Rich text editor (Quill) --- */
    .email-toolbar {
      border: 1px solid rgba(0,0,0,0.1);
      border-bottom: 0;
      border-radius: 6px 6px 0 0;
      background: #fff;
      margin-bottom: 0;
      overflow: hidden;
    }

    .email-editor {
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 0 0 6px 6px;
      background: #fff;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .ql-toolbar.ql-snow {
      border: none;
      border-radius: 6px 6px 0 0;
      padding: 10px 12px;
      font-family: 'Montserrat', sans-serif;
      background: #fff;
    }

    .ql-container.ql-snow {
      border: none;
      font-family: 'Montserrat', sans-serif;
      background: #fff;
    }

    .ql-editor {
      min-height: 220px;
      font-size: 14px;
      line-height: 1.55;
      padding: 14px 16px;
    }

    .ql-editor.ql-blank::before {
      color: #999;
      font-style: normal;
      left: 16px;
      right: 16px;
    }
  </style>
</head>

<body>

  <header class="admin-header">
    <h1>Email Campaign</h1>
    <a href="/admin.html">‚Üê Back to Admin</a>
  </header>

  <div class="campaign-container">

    <div id="statusMessage" class="status"></div>

    <!-- Step 1: Contacts -->
    <div class="card">
      <div class="card-title">Step 1: Add Contacts</div>

      <div class="tabs">
        <div class="tab active" data-tab="upload">Upload CSV</div>
        <div class="tab" data-tab="paste">Paste List</div>
      </div>

      <div id="upload-tab" class="tab-content active">
        <div class="drop-zone" id="dropZone">
          <div class="icon">üìÅ</div>
          <p>Drop your CSV file here, or click to select</p>
          <p style="font-size: 12px; color: #999; margin-top: 8px;">File must have columns: first_name, email</p>
        </div>
        <input type="file" id="csvFile" accept=".csv" style="display: none;">
      </div>

      <div id="paste-tab" class="tab-content">
        <label>Paste contacts (one per line: name, email)</label>
        <textarea id="pasteContacts" placeholder="Brandy, brandy@example.com&#10;Pattie, pattie@example.com"></textarea>
        <button class="btn btn-secondary" onclick="
          const raw = document.getElementById('pasteContacts').value.trim();
          if (!raw) { showStatus('error','Paste at least 1 contact'); return; }
          parsePastedContacts(raw);
        ">Add Contacts</button>
      </div>

      <div id="contactsPreview" style="display:none; margin-top: 18px;">
        <div class="helper-text"><strong>Loaded Contacts:</strong> <span id="contactCount">0</span></div>
        <table class="contacts-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="contactsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Step 2: Compose Email -->
    <div class="card">
      <div class="card-title">Step 2: Compose Email</div>

      <label>Subject Line</label>
      <input type="text" id="emailSubject" placeholder="It's been a minute...">

      <label>Email Body</label>
      <p class="helper-text">Use {first_name} to personalize. It will be replaced with each contact's name.</p>

      <div id="emailToolbar" class="email-toolbar"></div>
      <div id="emailEditor" class="email-editor"></div>
      <input type="hidden" id="emailTemplate">

      <div class="checkbox-wrapper">
        <input type="checkbox" id="useBranding" checked>
        <label for="useBranding">Use Tee Elite Circle branded template (header & footer)</label>
      </div>

      <button class="btn btn-secondary" onclick="showPreview()">Preview Email</button>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal" onclick="if(event.target.id==='previewModal') closePreview()">
      <div class="modal-content">
        <div class="modal-topbar">
          <span>Preview Email</span>
          <button class="modal-close" onclick="closePreview()" aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
          <div class="preview-header">
            <strong>To:</strong> <span id="previewTo"></span><br>
            <strong>Subject:</strong> <span id="previewSubject"></span>
          </div>
          <div id="previewBody"></div>
        </div>
      </div>
    </div>

    <!-- Step 3: Send -->
    <div class="card">
      <div class="card-title">Step 3: Send Campaign</div>

      <div class="warn-box">
        This sends emails in small batches with short pauses to help deliverability.
        Keep this tab open until it finishes.
      </div>

      <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px;">
        <button id="sendBtn" class="btn btn-primary" onclick="sendCampaign()">Send Campaign</button>
        <button id="stopBtn" class="btn btn-danger" onclick="stopCampaign()" disabled>Stop</button>
      </div>

      <div id="progressText" class="progress"></div>

      <div id="resultsBox" class="results">
        <h3>Results</h3>
        <div class="row">
          <div class="pill success">Sent: <span id="sentCount">0</span></div>
          <div class="pill error">Failed: <span id="failedCount">0</span></div>
        </div>
        <div style="margin-top: 14px;">
          <button class="btn btn-secondary" onclick="downloadResults()">Download CSV Results</button>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <script>
    let contacts = [];
    let campaignResults = null;
    let isSending = false;
    let shouldStop = false;

    let quill = null;

    function initEmailEditor() {
      const toolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link']
      ];

      quill = new Quill('#emailEditor', {
        theme: 'snow',
        placeholder: 'Write your email here... Use {first_name} to personalize.',
        modules: { toolbar: toolbarOptions }
      });

      // Move Quill's toolbar into our custom toolbar container
      const toolbarEl = document.querySelector('.ql-toolbar');
      const hostToolbar = document.getElementById('emailToolbar');
      if (toolbarEl && hostToolbar) hostToolbar.appendChild(toolbarEl);

      // Starter content (only if blank on load)
      const starter = [
        '<p>Hey {first_name},</p>',
        '<p><br></p>',
        '<p>Just checking in.</p>',
        '<p><br></p>',
        '<p>Dr. TMac</p>'
      ].join('');

      if (quill.getText().trim().length === 0) {
        quill.clipboard.dangerouslyPasteHTML(starter);
      }

      // Keep hidden field in sync (so existing code paths still work)
      syncHiddenTemplate();
      quill.on('text-change', syncHiddenTemplate);
    }

    function syncHiddenTemplate() {
      const hidden = document.getElementById('emailTemplate');
      if (hidden && quill) hidden.value = quill.root.innerHTML;
    }

    function getTemplateHtml() {
      if (quill) return quill.root.innerHTML;
      return document.getElementById('emailTemplate')?.value || '';
    }

    function isTemplateEmpty(html) {
      const cleaned = (html || '').replace(/\s/g, '').toLowerCase();
      return cleaned === '' || cleaned === '<p><br></p>' || cleaned === '<div><br></div>';
    }

    // Initialize editor (script is at bottom, DOM is ready)
    initEmailEditor();

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // Drag and drop
    const dropZone = document.getElementById('dropZone');
    const csvFile = document.getElementById('csvFile');

    dropZone.addEventListener('click', () => csvFile.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) parseCsvFile(file);
    });

    csvFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) parseCsvFile(file);
    });

    function showStatus(type, message) {
      const el = document.getElementById('statusMessage');
      el.className = `status ${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => {
        el.style.display = 'none';
      }, 4500);
    }

    async function parseCsvFile(file) {
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);

      if (lines.length < 2) {
        showStatus('error', 'CSV must include header + at least 1 row');
        return;
      }

      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const nameIndex = headers.indexOf('first_name');
      const emailIndex = headers.indexOf('email');

      if (nameIndex === -1 || emailIndex === -1) {
        showStatus('error', 'CSV must have columns: first_name, email');
        return;
      }

      const parsed = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',').map(c => c.trim());
        const first_name = cols[nameIndex] || '';
        const email = cols[emailIndex] || '';
        if (email) parsed.push({ first_name, email });
      }

      contacts = parsed;
      renderContacts();
      showStatus('success', `Loaded ${contacts.length} contacts`);
    }

    function parsePastedContacts(raw) {
      const lines = raw.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
      const parsed = [];

      for (const line of lines) {
        const parts = line.split(',').map(x => x.trim());
        if (parts.length < 2) continue;
        const first_name = parts[0];
        const email = parts[1];
        if (email) parsed.push({ first_name, email });
      }

      contacts = parsed;
      renderContacts();
      showStatus('success', `Loaded ${contacts.length} contacts`);
    }

    function renderContacts() {
      document.getElementById('contactsPreview').style.display = 'block';
      document.getElementById('contactCount').textContent = contacts.length;

      const tbody = document.getElementById('contactsBody');
      tbody.innerHTML = '';
      contacts.slice(0, 50).forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${escapeHtml(c.first_name || '')}</td><td>${escapeHtml(c.email || '')}</td>`;
        tbody.appendChild(tr);
      });

      if (contacts.length > 50) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3" style="color:#777; font-size:12px; padding:10px 8px;">Showing first 50 contacts only‚Ä¶</td>`;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function showPreview() {
      const subject = document.getElementById('emailSubject').value;
      const template = getTemplateHtml();

      if (!subject || !template || isTemplateEmpty(template)) {
        showStatus('error', 'Please fill in subject and email body');
        return;
      }

      const sampleName = contacts.length > 0 ? (contacts[0].first_name || 'there') : 'there';
      const sampleEmail = contacts.length > 0 ? contacts[0].email : 'example@email.com';

      document.getElementById('previewTo').textContent = sampleEmail;
      document.getElementById('previewSubject').textContent = subject;

      // Render HTML so links show as clickable text
      document.getElementById('previewBody').innerHTML = template.replace(/{first_name}/gi, sampleName);

      document.getElementById('previewModal').classList.add('visible');
    }

    function closePreview() {
      document.getElementById('previewModal').classList.remove('visible');
    }

    async function sendCampaign() {
      const subject = document.getElementById('emailSubject').value;
      const template = getTemplateHtml();
      const useTemplate = document.getElementById('useBranding').checked;

      if (!subject || !template || isTemplateEmpty(template)) {
        showStatus('error', 'Please fill in subject and email body');
        return;
      }

      if (contacts.length === 0) {
        showStatus('error', 'No contacts loaded');
        return;
      }

      if (!confirm(`Send ${contacts.length} emails?\n\nThis will send in batches to help deliverability.\nEstimated time: ~${Math.ceil((contacts.length / 10) * 0.5)} minutes.\n\nKeep this tab open until complete.`)) {
        return;
      }

      // Setup UI
      isSending = true;
      shouldStop = false;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('sendBtn').textContent = 'Sending...';
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('progressText').textContent = '';

      campaignResults = {
        sent: 0,
        failed: 0,
        rows: []
      };

      // Send in batches of 10
      const batchSize = 10;

      for (let i = 0; i < contacts.length; i += batchSize) {
        if (shouldStop) break;

        const batch = contacts.slice(i, i + batchSize);

        document.getElementById('progressText').textContent =
          `Sending ${Math.min(i + batch.length, contacts.length)} of ${contacts.length}...`;

        try {
          const res = await fetch('/api/admin/email-campaign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contacts: batch,
              subject,
              template,
              useTemplate
            })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Send failed');
          }

          // Track results
          data.results.forEach(r => {
            if (r.success) campaignResults.sent++;
            else campaignResults.failed++;

            campaignResults.rows.push(r);
          });

          updateResultsUI();

        } catch (err) {
          // Mark entire batch as failed
          batch.forEach(c => {
            campaignResults.failed++;
            campaignResults.rows.push({
              email: c.email,
              first_name: c.first_name || '',
              success: false,
              error: err.message || 'Batch failed'
            });
          });
          updateResultsUI();
        }

        // Pause between batches (avoid hammering)
        if (i + batchSize < contacts.length && !shouldStop) {
          await sleep(2500);
        }
      }

      // Finalize UI
      isSending = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('sendBtn').textContent = 'Send Campaign';
      document.getElementById('stopBtn').disabled = true;

      if (shouldStop) {
        showStatus('error', 'Campaign stopped.');
      } else {
        showStatus('success', `Done. Sent: ${campaignResults.sent}, Failed: ${campaignResults.failed}`);
      }
    }

    function stopCampaign() {
      if (!isSending) return;
      shouldStop = true;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('progressText').textContent = 'Stopping...';
    }

    function updateResultsUI() {
      const box = document.getElementById('resultsBox');
      box.classList.add('visible');
      document.getElementById('sentCount').textContent = campaignResults.sent;
      document.getElementById('failedCount').textContent = campaignResults.failed;
    }

    function downloadResults() {
      if (!campaignResults || !campaignResults.rows) return;

      const headers = ['email', 'first_name', 'success', 'error'];
      const lines = [headers.join(',')];

      campaignResults.rows.forEach(r => {
        const row = [
          safeCsv(r.email),
          safeCsv(r.first_name),
          safeCsv(String(!!r.success)),
          safeCsv(r.error || '')
        ];
        lines.push(row.join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campaign-results-${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function safeCsv(v) {
      const s = String(v ?? '');
      if (s.includes(',') || s.includes('"') || s.includes('\n')) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>

</body>
</html>
